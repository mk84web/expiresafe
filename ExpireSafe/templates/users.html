{% extends "base.html" %}
{% block title %}Users | ExpireSafe{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">User Management</h1>

<div class="bg-white dark:bg-slate-800 p-4 rounded shadow mb-6">
  <h2 class="font-semibold mb-3">Invite a new user</h2>
  <form method="post" class="flex flex-wrap gap-2 items-end">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <div class="min-w-[200px] flex-1">
      <label class="block text-xs text-slate-500 dark:text-slate-400">Email to invite*</label>
      <input type="email" name="email" required placeholder="manager@agency.com" class="w-full px-3 py-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200 dark:placeholder-slate-400" />
    </div>
    <div class="min-w-[120px]">
      <label class="block text-xs text-slate-500 dark:text-slate-400">Role*</label>
      <select name="role" class="w-full px-3 py-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200">
        <option value="MANAGER">MANAGER</option>
        <option value="OWNER">OWNER</option>
      </select>
    </div>
    <button class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Send invite link</button>
  </form>
  <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">They'll receive an email with a link to set their password (valid 3 days).</p>
</div>

<div class="bg-white dark:bg-slate-800 rounded shadow overflow-x-auto">
  <table class="w-full text-sm">
    <thead class="bg-slate-100 dark:bg-slate-700 text-left">
      <tr>
        <th class="px-4 py-2">Username</th>
        <th class="px-4 py-2">Email</th>
        <th class="px-4 py-2">Role</th>
        <th class="px-4 py-2">Status</th>
        <th class="px-4 py-2">Created</th>
        <th class="px-4 py-2">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr class="border-t dark:border-slate-700 {{ 'opacity-50' if u.is_active is not none and not u.is_active }}">
        <td class="px-4 py-2">{{ u.username }}</td>
        <td class="px-4 py-2">{{ u.email }}</td>
        <td class="px-4 py-2">
          <form method="post" action="{{ url_for('update_user_role', uid=u.id) }}" class="inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <select name="role" onchange="this.form.submit()" class="px-2 py-0.5 rounded text-xs border {{ 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300' if u.role=='OWNER' else 'bg-slate-100 text-slate-700 dark:bg-slate-600 dark:text-slate-200' }} dark:border-slate-500">
              <option value="OWNER" {{ 'selected' if u.role=='OWNER' }}>OWNER</option>
              <option value="MANAGER" {{ 'selected' if u.role=='MANAGER' }}>MANAGER</option>
            </select>
          </form>
        </td>
        <td class="px-4 py-2">
          {% if u.is_active is none or u.is_active %}
          <span class="text-xs text-green-600 dark:text-green-400">Active</span>
          {% else %}
          <span class="text-xs text-red-600 dark:text-red-400">Deactivated</span>
          {% endif %}
        </td>
        <td class="px-4 py-2 text-slate-500 dark:text-slate-400 text-xs">{{ u.created_at[:10] }}</td>
        <td class="px-4 py-2">
          <form method="post" action="{{ url_for('toggle_user_active', uid=u.id) }}" class="inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            {% if u.is_active is none or u.is_active %}
            <button class="text-slate-800 dark:text-slate-200 hover:underline text-xs" onclick="return confirm('Deactivate this user?')">Deactivate</button>
            {% else %}
            <button class="text-green-600 dark:text-green-400 hover:underline text-xs">Activate</button>
            {% endif %}
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6" class="px-4 py-4 text-center text-slate-400 dark:text-slate-400">No users yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
