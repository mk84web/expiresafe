{% extends "base.html" %}
{% block title %}Backups | ExpireSafe{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold">Backups</h1>
    <form method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <input type="hidden" name="action" value="backup" />
      <button class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium text-sm flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5 5-5M12 15V3"/></svg>
        Create Backup Now
      </button>
    </form>
  </div>

  <!-- What gets backed up -->
  <div class="grid sm:grid-cols-2 gap-4 mb-8">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-5">
      <div class="flex items-center gap-2 mb-2">
        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7M9 3h6l1 4H8L9 3z"/></svg>
        <h3 class="font-semibold dark:text-slate-100">Database</h3>
      </div>
      <p class="text-sm text-slate-500 dark:text-slate-400">Agencies, users, staff, documents, audit logs, billing — everything. Uses SQLite safe backup API.</p>
    </div>
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-5">
      <div class="flex items-center gap-2 mb-2">
        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
        <h3 class="font-semibold dark:text-slate-100">Uploads</h3>
      </div>
      <p class="text-sm text-slate-500 dark:text-slate-400">DBS files, training certificates, PDFs — all uploaded evidence. Full folder copy.</p>
    </div>
  </div>

  <!-- Backup history -->
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="bg-slate-100 dark:bg-slate-700 text-left">
        <tr>
          <th class="px-4 py-3 font-medium text-slate-600 dark:text-slate-300">Date</th>
          <th class="px-4 py-3 font-medium text-slate-600 dark:text-slate-300">Database</th>
          <th class="px-4 py-3 font-medium text-slate-600 dark:text-slate-300">Uploads</th>
          <th class="px-4 py-3 font-medium text-slate-600 dark:text-slate-300">Created</th>
          <th class="px-4 py-3 font-medium text-slate-600 dark:text-slate-300 text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for b in backups %}
        <tr class="border-t dark:border-slate-700/60">
          <td class="px-4 py-3 font-medium dark:text-slate-200">{{ b.date }}</td>
          <td class="px-4 py-3">
            {% if b.db_exists %}
            <span class="inline-flex items-center gap-1.5 text-xs font-medium dark:text-white">
              <span class="w-1.5 h-1.5 rounded-full bg-green-500 opacity-80"></span>
              {{ b.db_size_fmt }}
            </span>
            {% else %}
            <span class="text-xs text-slate-400">—</span>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            {% if b.uploads_exist %}
            <span class="inline-flex items-center gap-1.5 text-xs font-medium dark:text-white">
              <span class="w-1.5 h-1.5 rounded-full bg-green-500 opacity-80"></span>
              {{ b.upload_files }} files ({{ b.upload_size_fmt }})
            </span>
            {% else %}
            <span class="text-xs text-slate-400">—</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-slate-600 dark:text-slate-400 text-xs">{{ b.created_at[:19] if b.created_at else '—' }}</td>
          <td class="px-4 py-3 text-right">
            <form method="post" class="inline" onsubmit="return confirm('⚠️ Restore from {{ b.date }}? This will OVERWRITE the current database and uploads.')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
              <input type="hidden" name="action" value="restore" />
              <input type="hidden" name="date" value="{{ b.date }}" />
              <button class="text-slate-600 dark:text-slate-300 hover:underline text-xs">Restore</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-slate-400 dark:text-slate-400">
            No backups yet. Click "Create Backup Now" to make your first one.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <p class="text-sm text-slate-500 dark:text-slate-400 mt-5 text-center">
    Backups are stored in dated folders. Each date keeps the latest snapshot. You can also run <code class="dark:text-slate-300">python backup.py</code> from the command line.
  </p>
</div>
{% endblock %}
